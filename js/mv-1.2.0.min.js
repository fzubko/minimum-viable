export function mvStart(e){let t=createScope(null,{},"$rootScope"),r=()=>{let e=document.baseURI.replace(document.location.origin,""),a=document.getElementsByTagName("html")[0];a.classList.add("loading"),interpolate(a,t,e).then(()=>a.classList.remove("loading")),removeEventListener("load",r)};addEventListener("load",r),e&&e(t)}export const Logger={css:{caller:"color: #888; margin-left: 0.5rem;",create:e=>"background: #073; color: #fffd; padding: 0 0.3rem; border-radius: 0.3rem;"+(e?"margin-left: "+1.5*e+"rem;":""),access:e=>"background: #048; color: #fffd; padding: 0 0.3rem; border-radius: 0.3rem;"+(e?"margin-left: "+1.5*e+"rem;":""),invoke:e=>"background: #088; color: #fffd; padding: 0 0.3rem; border-radius: 0.3rem;"+(e?"margin-left: "+1.5*e+"rem;":""),update:e=>"background: #770; color: #fffd; padding: 0 0.3rem; border-radius: 0.3rem;"+(e?"margin-left: "+1.5*e+"rem;":""),remove:e=>"background: #850; color: #fffd; padding: 0 0.3rem; border-radius: 0.3rem;"+(e?"margin-left: "+1.5*e+"rem;":""),broken:e=>"background: #A00; color: #fffd; padding: 0 0.3rem; border-radius: 0.3rem;"+(e?"margin-left: "+1.5*e+"rem;":"")},icon:{watching:String.fromCodePoint(128064),sleeping:String.fromCodePoint(128164),skipping:String.fromCodePoint(8634)},noCallbacks:!1,innumerable:!1,scopeCreate:!1,scopeAccess:!1,scopeInvoke:!1,scopeUpdate:!1,scopeRemove:!1,scopeBroken:!0,set scope(value){Logger.scopeCreate=value,Logger.scopeAccess=value,Logger.scopeInvoke=value,Logger.scopeUpdate=value,Logger.scopeRemove=value,Logger.scopeBroken=value},textCreate:!1,textUpdate:!1,textRemove:!1,textBroken:!0,set text(value){Logger.textCreate=value,Logger.textUpdate=value,Logger.textRemove=value,Logger.textBroken=value},templateCreate:!1,templateInvoke:!1,templateUpdate:!1,templateBroken:!0,set template(value){Logger.templateCreate=value,Logger.templateInvoke=value,Logger.templateUpdate=value,Logger.templateBroken=value},pageCreate:!1,pageUpdate:!1,pageBroken:!0,set page(value){Logger.pageCreate=value,Logger.pageUpdate=value,Logger.pageBroken=value},eventCreate:!1,eventInvoke:!1,set event(value){Logger.eventCreate=value,Logger.eventInvoke=value},eachCreate:!1,eachUpdate:!1,eachRemove:!1,eachBroken:!0,set each(value){Logger.eachCreate=value,Logger.eachUpdate=value,Logger.eachRemove=value,Logger.eachBroken=value},ifCreate:!1,ifUpdate:!1,ifRemove:!1,ifBroken:!0,set if(value){Logger.ifCreate=value,Logger.ifUpdate=value,Logger.ifRemove=value,Logger.ifBroken=value},attrCreate:!1,attrUpdate:!1,attrRemove:!1,attrBroken:!0,set attr(value){Logger.attrCreate=value,Logger.attrUpdate=value,Logger.attrRemove=value,Logger.attrBroken=value},set all(value){Logger.noCallbacks=value,Logger.innumerable=value,Logger.scope=value,Logger.text=value,Logger.template=value,Logger.page=value,Logger.event=value,Logger.each=value,Logger.if=value,Logger.attr=value,value&&Logger.legend()},legend(){console.debug("Logger Legend%ccreate%caccess%cinvoke%cupdate%cremove%cbroken",Logger.css.create(.5),Logger.css.access(.5),Logger.css.invoke(.5),Logger.css.update(.5),Logger.css.remove(.5),Logger.css.broken(.5)),console.debug(Logger.icon.watching,"watching, callback is registered for changes"),console.debug(Logger.icon.sleeping,"sleeping, callback waited until end of stack to execute"),console.debug(Logger.icon.skipping,"skipping, skipped callback, this one was already queued at the end of the stack")},redact(e){let t=e;return["function","object"].forEach(r=>t=typeof e===r&&null!=e?"|"+r+"|":t),t},get caller(){try{return/[a-zA-Z0-9_-]+\.\w+:\d+/.exec(Error().stack.split("\n")[3])[0]}catch(e){return""}}};export function evaluate(e,t,r){Function("$scope","event",`'use strict'; ${r};`).call(this,e,t)}export function evaluateAsObject(e,t){return Function("$scope",`'use strict'; return ${t};`)(e)}export function evaluateAsBoolean(e,t){return Function("$scope",`'use strict'; return !!(${t});`)(e)}export function evaluateTemplateLiteral(e,t){return Function("$scope",`'use strict'; return \`${t}\`;`)(e)}export async function interpolate(e,t,r="/"){mvHref(e),mvEvent(e,t),mvText(e,t),mvBind(e,t),mvAttr(e,t),mvIf(e,t),mvEach(e,t),await mvTemplate(e,t,r),mvPage(e,t,r)}export function createScope(e,t,r,a){let o,n=new Promise((e,a)=>{o=async a=>{n.finally(()=>{Logger.scopeRemove&&console.debug("%c"+r,Logger.css.remove(t.$depth));let e=[];for(let a of t.$children)e.push(a.$unload());Promise.all(e).then(()=>{Logger.scopeRemove&&console.debug("%c"+r,Logger.css.remove(t.$depth),"revoke"),g()})}),e(a),await n}});Object.defineProperties(t,{$label:{value:r},$parent:{value:e},$children:{value:new Set},$depth:{value:(()=>{let t=(e,r)=>e.$parent?t(e.$parent,r+1):r;return e?t(e,1):0})()},$routers:{value:[]},addRouter:{value(){let e,r=t=>(e.test=t,{goto:a,load:o}),a=t=>(e.newPathname=t,n.routes.push(e),n),o=(t,r)=>(e.templateSource=t,e.templateFunction=r,n.routes.push(e),n),n={when:e=>n.whenMatch(`^${e}$`),otherwise:e=>n.whenMatch(".").goto(e),whenMatch:t=>(e={pattern:t,test:!0},{assert:r,goto:a,load:o}),routes:[]};return t.$routers.push(n),n}},whenUnload:{value:n},$unload:{value:o},$dependencyChangeFunction:{value:null,writable:!0},$callbackMap:{value:{load:new Map,change:new Map,changeOnce:new Map,changeOnceDOM:new Map,shift:new Set,pop:new Set,unshift:new Set,push:new Set,sort:new Set,reverse:new Set,splice:new Set,copyWithin:new Set,fill:new Set}},on:{value(e,r,a){["load","change","changeOnce","changeOnceDOM"].includes(e)?(t.$callbackMap[e].get(r) instanceof Set||t.$callbackMap[e].set(r,new Set),t.$callbackMap[e].get(r).add(a)):(t.$callbackMap[e].add(r),"load"===e&&console.warn(r))}},trigger:{value:function(e,a){let o=0,n=0,c,l,g;"change"===e?(c=[e,a],Array.from(t.$callbackMap.changeOnceDOM.get(a)||[]).forEach((e,a)=>{n++,addToEndOfStack(e,e=>Logger.scopeInvoke&&console.debug("%c"+r,Logger.css.invoke(t.$depth),...c,"callback",o++,e))}),t.$callbackMap.changeOnceDOM.delete(a),l=new Set([...t.$callbackMap.change.get(a)||[],...t.$callbackMap.changeOnce.get(a)||[]]),g=[t[a]],t.$callbackMap.changeOnce.delete(a)):"load"===e?(c=[e,a],l=new Set([...t.$callbackMap.load.get(a)||[]])):(c=[e],l=new Set([...t.$callbackMap[e]]),g=Array.from(arguments).slice(1)),Logger.scopeInvoke&&(Logger.noCallbacks||l.size+n>0)&&console.debug("%c"+r,Logger.css.invoke(t.$depth),...c,"callbacks",l.size+n),l.forEach(e=>{Logger.scopeInvoke&&console.debug("%c"+r,Logger.css.invoke(t.$depth),...c,"callback",o++),e.apply(t,g)})}}}),Logger.scopeCreate&&console.debug("%c"+r,Logger.css.create(t.$depth),t.toJSON?t.toJSON():"");let c={get:scopeGet,set:scopeSet,deleteProperty:scopeDelete,apply:(e,t,r)=>(console.warn("APPLY!!",e,t,r),Reflect.apply(e,t,r))},{proxy:l,revoke:g}=Proxy.revocable(t,c);return c.$scope=l,c.propertyName=a,e&&(e.$children.add(l),t.whenUnload.then(()=>e.$children.delete(l))),Object.entries(t).forEach(([e,a])=>{"object"!=typeof a||null==a||a.hasOwnProperty("$label")||(t[e]=createScope(l,a,r+"."+e,e))}),l}let endOfStackChanges=new Set,changesQueued=!1;function addToEndOfStack(e,t){if(endOfStackChanges.has(e)){endOfStackChanges.add(()=>t(Logger.icon.skipping));return}endOfStackChanges.add(e),changesQueued||(changesQueued=!0,Promise.resolve().then(()=>{let e=new Set(endOfStackChanges);endOfStackChanges.clear(),changesQueued=!1,t(Logger.icon.sleeping),e.forEach(e=>e())}))}export function scopeGet(e,t,r){let a=null!==e.$dependencyChangeFunction?Logger.icon.watching:"";if(["$label","$depth"].includes(t))return e[t];if((Logger.innumerable||e.propertyIsEnumerable(t))&&Logger.scopeAccess&&console.debug("%c"+e.$label+"%c"+Logger.caller,Logger.css.access(e.$depth),Logger.css.caller,t,"=",Logger.redact(e[t]),a),null!==e.$dependencyChangeFunction&&(e.on("changeOnceDOM",t,e.$dependencyChangeFunction),"object"==typeof e[t]&&null!=e[t]&&(e[t].$dependencyChangeFunction=e.$dependencyChangeFunction,e.on("changeOnce","$dependencyChangeFunction",()=>e[t].$dependencyChangeFunction=null))),"object"==typeof e&&"toString"===t&&"function"==typeof e[t]&&"[object Object]"===e[t]())return()=>JSON.stringify(this.$scope);if(e instanceof Date&&"string"==typeof t&&"function"==typeof e[t]){if(t.startsWith("set"))return(...r)=>{let a=e.toString(),o=Date.prototype[t].apply(e,r);return a!==o.toString()&&e.$parent.trigger("change",this.propertyName),o};if(/^get|^to|^valueOf$/.exec(t))return e[t].bind(e)}if(e instanceof Array){let o=t=>t.map(t=>"object"!=typeof t||null==t||t.hasOwnProperty("$label")?t:createScope(e,t,e.$label+".mutation"));if(["unshift","push"].includes(t))return(...r)=>{r=o(r);let a=Array.prototype[t].apply(e,r);return e.trigger(t,...r),e.trigger("change","length"),a};if(["shift","pop"].includes(t))return(...r)=>{r=o(r);let a=Array.prototype[t].apply(e,r);return e.trigger(t,...r),e.trigger("change","length"),a};if(["reverse"].includes(t))return()=>{let r=Array.prototype[t].call(e);return e.trigger(t),e.trigger("change","toJSON"),r};if(["sort"].includes(t))return t=>{let r=sortIndices(e,t);return e.trigger("sort",r),e.trigger("change","toJSON"),e};if(["splice"].includes(t))return(r,a,...n)=>{n=o(n);let c=Array.prototype[t].apply(e,[r,a,...n]);return e.trigger(t,r,a,...n),a!=n.length&&e.trigger("change","length"),a+n.length>0&&e.trigger("change","toJSON"),c};if(["copyWithin"].includes(t))return(r,a,o=e.length)=>{let n=Array.prototype[t].apply(e,[r,a,o]);return e.trigger(t,r,a,o),r<e.length&&o-a>0&&e.trigger("change","toJSON"),n};if(["fill"].includes(t))return(r,a,n=e.length)=>{r=o([r])[0];let c=Array.prototype[t].apply(e,[r,a,n]);return e.trigger(t,r,a,n),a<e.length&&n-a>0&&e.trigger("change","toJSON"),c}}return Reflect.get(e,t,r)}function sortIndices(e,t=(e,t)=>String(e).localeCompare(t)){let r=e.map((e,t)=>t);return!function e(r,a,o,n){if(o<n){let c=Math.floor((o+n)/2);e(r,a,o,c),e(r,a,c+1,n),function e(r,a,o,n,c){let l=o,g=n+1;for(;l<=n&&g<=c;)if(0>=t(r[l],r[g]))l++;else{let s=g;for(;s>l;)[r[s],r[s-1]]=[r[s-1],r[s]],[a[s],a[s-1]]=[a[s-1],a[s]],s--;l++,n++,g++}}(r,a,o,c,n)}}(e,r,0,e.length-1),r}export function scopeSet(e,t,r,a){if((Logger.innumerable||!e.hasOwnProperty(t)||e.propertyIsEnumerable(t))&&Logger.scopeUpdate&&console.debug("%c"+e.$label,Logger.css.update(e.$depth),t,"=",Logger.redact(e[t]),">>",Logger.redact(r)),e[t]===r)return!0;if("$dependencyChangeFunction"===t&&null!=r)return Reflect.set(e,t,r,a);if(e.$dependencyChangeFunction&&"$dependencyChangeFunction"!==t)return Logger.scopeBroken&&console.error("%c"+e.$label,Logger.css.broken(e.$depth),`attempted update of '${t}', mv syntax should be idempotent`),!1;let o="object"==typeof e[t]&&null!=e[t]?"object":"literal",n="object"==typeof r&&null!=r?"object":"literal",c="object"===n?createScope(this.$scope,r,e.$label+"."+t,t):r;if("object"===o)return e[t].$unload().then(()=>{Reflect.set(e,t,c,a),e.trigger("change",t),"object"===n&&e.trigger("load",t)}),!0;let l=e instanceof Array&&t>=e.length;return Reflect.set(e,t,c,a),e.trigger("change",t),"object"===n&&e.trigger("load",t),l&&(e.trigger("change","length"),e.trigger("change","toJSON")),!0}export function scopeDelete(e,t){if(Logger.scopeRemove&&console.debug("%c"+e.$label,Logger.css.remove(e.$depth),t,"=",Logger.redact(e[t])),"object"==typeof e[t]&&null!=e[t])return e[t].$unload().then(()=>{Reflect.deleteProperty(e,t),e.trigger("change",t)}),!0;let r=Reflect.deleteProperty(e,t);return e.trigger("change",t),r}export function mvBind(e,t){for(let r of getBindNodes(e,!0)){let a=r.getAttribute("mv-bind");for(let o of(t[a]??={},r.querySelectorAll(":scope :not([type=button], [type=image], [type=reset], [type=submit])[name]"))){let n=o.getAttribute("name");t[a][n]??=o.value,o.setAttribute("mv-bind",a+"."+n)}}for(let c of getBindNodes(e,!1)){let l=c.getAttribute("mv-bind").split(".").slice(0,-1).reduce((e,t)=>e[t],t),g=c.getAttribute("mv-bind").split(".").pop(),s=(c.hasAttribute("multiple")?"multi-":"")+("INPUT"===c.tagName?c.type||"text":c.tagName),i,p;switch(s.toLowerCase()){case"date":case"week":case"month":case"time":i=()=>{if(null==(c.value||null)){l[g]=null;return}l[g]=c.valueAsDate},p=e=>{e?c.valueAsDate=new Date(e.getTime()):c.value=null};break;case"datetime-local":i=()=>{if(null==(c.value||null)){l[g]=null;return}let e=c.value.split(/[-T:.]/);e[1]=e[1]-1,e.length>6&&(e[6]=e[6].padEnd(3,"0")),l[g]=getNewUtcDate(...e)},p=()=>{if(l[g]){let e=new Date(l[g].getTime());c.value=e.getUTCFullYear()+"-"+(e.getUTCMonth()+1).toString().padStart(2,"0")+"-"+e.getUTCDate().toString().padStart(2,"0")+"T"+e.getUTCHours().toString().padStart(2,"0")+":"+e.getUTCMinutes().toString().padStart(2,"0")+":"+e.getUTCSeconds().toString().padStart(2,"0")+"."+e.getUTCMilliseconds().toString().padStart(3,"0")}else c.value=null};break;case"radio":l[g]??=c.value,i=()=>{l[g]=c.value},p=()=>{c.checked=c.value==l[g]};break;case"checkbox":l[g]??=c.checked,i=()=>{l[g]=c.checked},p=()=>{c.checked=!!l[g]};break;case"file":case"multi-file":l[g]=c.files,i=()=>{l[g]=c.files};break;case"multi-select":l[g]??=[],i=()=>{let e=Array.from(c.options).every(e=>numberPattern.exec(e.value)),t=new Set;for(let r of c.selectedOptions)t.add(e?Number(r.value):r.value);for(let a=l[g].length;a--;){let o=l[g][a];t.has(o)?t.delete(o):l[g].splice(a,1)}t.forEach(e=>l[g].push(e));let n=Array.from(c.selectedOptions).map(e=>e.value);l[g].sort((e,t)=>{let r=n.indexOf(e.toString()),a=n.indexOf(t.toString());return r.toString().localeCompare(a,void 0,{numeric:!0})})},p=()=>{let e=Array.from(c.options).every(e=>numberPattern.exec(e.value)),t=new Set(l[g]);for(let r of c.options)r.selected=t.has(e?Number(r.value):r.value)};break;case"number":case"range":l[g]??=c.valueAsNumber,i=()=>{l[g]=c.valueAsNumber},p=()=>{c.value=l[g]};break;case"color":case"email":case"hidden":case"password":case"search":case"select":case"tel":case"text":case"textarea":case"url":l[g]??=c.value,i=()=>{l[g]=c.value},p=()=>{c.value=l[g]};break;default:console.error("Unsupported mv-bind",c)}c.addEventListener("input",i),t.whenUnload.then(()=>c.removeEventListener("input",i)),p&&(p(l[g]),l.on("change",g,p)),"multi-select"===s.toLowerCase()&&(["unshift","push","shift","pop","splice","copyWithin","fill"].forEach(e=>{l[g].on(e,p)}),l[g].on("change","length",p))}}let numberPattern=RegExp(/^(-?(0|[1-9]\d*)(\.\d+)?|\.\d+)$/);function*getBindNodes(e,t){let r=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,e=>e.hasAttribute("mv-each")?NodeFilter.FILTER_REJECT:"FORM"===e.nodeName===t&&e.hasAttribute("mv-bind")?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP);for(;r.nextNode();)yield r.currentNode}export function mvEach(e,t){let r=function*(){for(;;){let t=e.querySelector(":scope [mv-each]");if(!t)break;yield t}}();for(let a of r){let o=a.getAttribute("mv-each"),n=`mv-each="${o}"`,c=document.createComment(n);a.before(c),a.removeAttribute("mv-each");let l=o.split(" in ")[0],g=o.split(" in ")[1],s=g.split(".").slice(0,-1).reduce((e,t)=>e[t],t),i=g.split(".").pop(),p=t.$label+`.${g}[${l}]`,d=[],u=[],h=0;if(2!==o.split(" in ").length)return a.classList.add("broken"),Logger.eachBroken&&console.error("%c"+n,Logger.css.broken(t.$depth),"improper mv-each statement");if(!s[i])return a.classList.add("broken"),Logger.eachBroken&&console.error("%c"+n,Logger.css.broken(t.$depth),`no list named '${g}'`);function f(e,r){let o=0==e?c:d[e-1];Logger.eachCreate&&console.debug(`%c${n}[${e}]%c${Logger.caller}`,Logger.css.create(t.$depth),Logger.css.caller),d.splice(e,0,a.cloneNode(!0)),u.splice(e,0,createScope(t,{[l]:r},p)),(o.$domAnchor??o).after(d[e]),interpolate(d[e],u[e]);let g=t=>u[e][l]=t;s[i].on("change",""+e,g),u[e].whenUnload.then(()=>{try{s[i].$callbackMap.change.get(""+e).delete(g)}catch(t){if(!(t instanceof TypeError))throw t}}),h++}function m(e){if(0===h)return!1;let r=d.splice(e,1)[0],a=u.splice(e,1)[0];h--;try{Logger.eachRemove&&console.debug("%c"+n+"%c"+Logger.caller,Logger.css.remove(t.$depth),Logger.css.caller,e)}catch(o){if(!(o instanceof TypeError))throw o}try{r.remove(),a.$unload()}catch(c){if(!(c instanceof TypeError))throw c}return!0}a.remove(),Logger.eachCreate&&console.debug("%c"+n,Logger.css.create(t.$depth));let L={unshift(...e){Logger.eachUpdate&&console.debug("%c"+n,Logger.css.update(t.$depth),"unshift x",e.length),e.toReversed().forEach(e=>f(0,e))},push(...e){Logger.eachUpdate&&console.debug("%c"+n,Logger.css.update(t.$depth),"push x",e.length),e.forEach(e=>f(h,e))},shift(){Logger.eachUpdate&&console.debug("%c"+n,Logger.css.update(t.$depth),"shift"),m(0)},pop(){Logger.eachUpdate&&console.debug("%c"+n,Logger.css.update(t.$depth),"pop"),m(h-1)},reverse(){Logger.eachUpdate&&console.debug("%c"+n,Logger.css.update(t.$depth),"reverse"),d.forEach(e=>c.after(e)),d.reverse(),u.reverse()},sort(e){Logger.eachUpdate&&console.debug("%c"+n,Logger.css.update(t.$depth),"sort"),reorder(d,e),reorder(u,e),d.forEach((e,t)=>{(0===t?c:d[t-1]).after(e)})},splice(e,r,...a){Logger.eachUpdate&&console.debug("%c"+n,Logger.css.update(t.$depth),"splice",e,r,a.length);for(let o=0;o<r&&e<h;o++)m(e);a.forEach((t,r)=>{f(e+r,t)})},copyWithin(e,r,a=h){Logger.eachUpdate&&console.debug("%c"+n,Logger.css.update(t.$depth),"copyWithin",e,r,a);for(let o=0;e+o<h&&o<a-r;o++)m(e+o),f(e+o,s[i][e+o])},fill(e,r,a=h){Logger.eachUpdate&&console.debug("%c"+n,Logger.css.update(t.$depth),"fill",Logger.redact(e),r,a);for(let o=r;o<h&&o<a;o++)m(o),f(o,e)}},b=(e=s[i][h])=>{for(Logger.eachUpdate&&console.debug("%c"+n,Logger.css.update(t.$depth),"length",h,">>",e);h<e;)f(h,s[i][h]);for(;h>e;)m(h-1)},v=()=>{for(;h>0;)m(h-1);for(let e=0;e<s[i].length;e++)f(e,s[i][e]);for(let[t,r]of(s[i].on("change","length",b),Object.entries(L)))s[i].on(t,r)},k=e=>{if(!e)for(;h>0;)console.warn("length =",h,"removing"),m(h-1),console.warn("  good")};for(let[C,y]of(t.whenUnload.then(()=>{s?.[i].$callbackMap.change.get("length").delete(b),s.$callbackMap.load.get(i).delete(v),s.$callbackMap.load.get(i).delete(k)}),Object.entries(L)))t.whenUnload.then(()=>s?.[i].$callbackMap[C].delete(y));s.on("change",i,k),s.on("load",i,v),s[i]&&v()}}function reorder(e,t){return e.map((r,a)=>e[t[a]]).forEach((t,r)=>e[r]=t),e}export function mvEvent(e,t){let r=new Map([["mv-click","click"],["mv-submit","submit"]]);for(let[a,o]of r){let n=t.$label+`[${a}]`;for(let c of getEventNodes(e,a)){Logger.eventCreate&&console.debug("%c"+n,Logger.css.create(t.$depth));let l=e=>{try{Logger.eventInvoke&&console.debug("%c"+n,Logger.css.invoke(t.$depth)),e.preventDefault(),evaluate.call(c,t,e,c.getAttribute(a))}catch(r){console.warn("%c"+a,"color: darkorange;","\n",r)}};c.addEventListener(o,l),t.whenUnload.then(()=>removeEventListener(o,l))}}}function*getEventNodes(e,t){let r=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,e=>e.hasAttribute("mv-each")?NodeFilter.FILTER_REJECT:e.hasAttribute(t)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP);for(;r.nextNode();)yield r.currentNode}export function mvHref(e){for(let t of getHrefNodes(e))t.addEventListener("click",e=>{e.stopPropagation(),e.preventDefault(),history.pushState("","",t.getAttribute("href")),document.location.hash&&document.querySelector(document.location.hash)&&document.querySelector(document.location.hash).scrollIntoView(),dispatchEvent(new Event("popstate"))})}function*getHrefNodes(e){let t=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,e=>e.hasAttribute("mv-each")?NodeFilter.FILTER_REJECT:e.hasAttribute("mv-href")?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP);for(;t.nextNode();)yield t.currentNode}export function mvIf(e,t){let r=Promise.resolve();for(let a of getIfNodes(e)){let o=a.getAttribute("mv-if"),n=`mv-if="${o}"`,c=document.createComment(n);Logger.ifCreate&&console.debug("%c"+n,Logger.css.create(t.$depth));let l=()=>{Logger.ifUpdate&&console.debug("%c"+n,Logger.css.update(t.$depth),s);let e=g();s!=e&&((s=e)?(c.replaceWith(a),a.$domAnchor=a):(a.replaceWith(c),a.$domAnchor=c)),Logger.ifUpdate&&console.debug("%c"+n,Logger.css.update(t.$depth),s)},g=()=>{try{return t.$dependencyChangeFunction=l,evaluateAsBoolean(t,o)}catch(e){Logger.ifBroken&&console.error("%c"+n,Logger.css.broken(t.$depth),"\n",e)}finally{t.$dependencyChangeFunction=null}},s=g();s||r.then(()=>{a.replaceWith(c),a.$domAnchor=c}),t.whenUnload.then(()=>{Logger.ifRemove&&console.debug("%c"+n,Logger.css.remove(t.$depth));let e=t=>{t.$parent&&e(t.$parent),t.$callbackMap.changeOnceDOM.forEach(e=>e.delete(l))};e(t)})}}function*getIfNodes(e){let t=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,e=>e.hasAttribute("mv-each")?NodeFilter.FILTER_REJECT:e.hasAttribute("mv-if")?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP);for(e.hasAttribute("mv-if")&&(yield t.currentNode);t.nextNode();)yield t.currentNode}export function mvPage(e,t,r){e.querySelectorAll(":scope [mv-page]").forEach((e,a)=>{let o=e.outerHTML,n=t.$routers[a];if(!t.$routers[a])return e.classList.add("broken"),Logger.pageBroken&&console.error("%c"+o,Logger.css.broken(t.$depth),"no router");Logger.pageCreate&&console.debug("%c"+o,Logger.css.create(t.$depth));let c,l,g=a=>{let g=document.baseURI.replace(document.location.origin,"").slice(0,-1),s=n.routes.find(e=>!!RegExp(e.pattern).test(document.location.pathname.replace(g,""))&&!!e.test&&("function"==typeof e.test?(async()=>await e.test())():e.test));if(c==s||(c=s,Logger.pageUpdate&&console.debug("%c"+o,Logger.css.update(t.$depth),document.location.pathname,s),l&&(l.$unload(),l=null),e.innerHTML="",!s))return;if(s.newPathname){s.newPathname!=location.pathname&&(history.pushState("","",g+s.newPathname),dispatchEvent(new Event("popstate")));return}let i=document.createElement("div");i.setAttribute("mv-template",s.templateFunction??""),i.setAttribute("src",s.templateSource),e.appendChild(i),Logger.pageCreate&&console.debug("%c"+o,Logger.css.update(t.$depth),s.templateSource,s.templateFunction??""),mvTemplate(e,t,r).then(e=>{l=e[0],document.location.hash&&document.querySelector(document.location.hash)&&document.querySelector(document.location.hash).scrollIntoView()})};addEventListener("popstate",g),g()})}let templatePromiseCache={},templateScriptCache={},templateCssCache={},templateCache={},templateModuleCache={};export async function mvTemplate(e,t,r){let a=Array.from(e.querySelectorAll(":scope [mv-template]"));async function o(e){let a=e.getAttribute("src"),o=(a.startsWith("/")?"":r)+a,n=o.split("/").slice(0,-1).map(e=>e+"/").join(""),c=e.getAttribute("mv-template"),l=`mv-tempate=${c} ${o}`,g=createScope(t,{},o);if(!o)return e.classList.add("broken"),Logger.templateBroken&&console.error("%c"+l,Logger.css.broken(t.$depth),"missing [src] attribute");Logger.templateCreate&&console.debug("%c"+l,Logger.css.create(t.$depth)),e.classList.add("loading");let s=document.createComment(l);e.before(s),e.removeAttribute("mv-template"),templatePromiseCache[o]||(templatePromiseCache[o]=fetch(o),templateCache[o]=document.createElement("template"),templateCache[o].innerHTML=await templatePromiseCache[o].then(e=>e.ok?e.text():""));let i=Array.from(templateCache[o].content.querySelectorAll("script")),p=Array.from(templateCache[o].content.querySelectorAll("link[rel=stylesheet]"));await Promise.all([...i.map(e=>loadScript(t,e,l,o,n)),...p.map(e=>loadCss(t,e,l,n))]);let d=templateCache[o].content.cloneNode(!0);if(e.innerHTML="",e.append(d),Logger.templateUpdate&&console.debug("%c"+l,Logger.css.update(t.$depth),"loaded"),c){let u=(templateModuleCache[o]||[]).find(e=>e[c]);if(!u)return e.classList.add("broken"),Logger.templateBroken&&console.error("%c"+l,Logger.css.broken(t.$depth),`template function '${c}' not found or not exported`);Logger.templateInvoke&&console.debug("%c"+l,Logger.css.invoke(t.$depth),c),u[c].call(d,g)}return await interpolate(e,g,n),e.classList.remove("loading"),g}return e.matches("[mv-template]")&&a.unshift(e),await Promise.all(a.map(o)).then(e=>e)}async function loadScript(e,t,r,a,o){let n=t.getAttribute("src");templateScriptCache[n=n.startsWith("/")?n:o+n]||(templateModuleCache[a]=templateModuleCache[a]??[],templateScriptCache[n]=import(n),await templateScriptCache[n],templateScriptCache[n].then(t=>{templateModuleCache[a].push(t),Logger.templateUpdate&&console.debug("%c"+r,Logger.css.update(e.$depth),n)})),t.remove()}async function loadCss(e,t,r,a){let o=t.getAttribute("href");templateCssCache[o=o.startsWith("/")?o:a+o]||(templateCssCache[o]=import(o,{with:{type:"css"}}),await templateCssCache[o],templateCssCache[o].then(t=>{document.adoptedStyleSheets.push(t.default),Logger.templateUpdate&&console.debug("%c"+r,Logger.css.update(e.$depth),o)})),t.remove()}export function mvText(e,t){for(let r of getTextNodes(e)){let a=r.nodeValue,o=a.replace(/{{/g,"${").replace(/}}/g,"}"),n=()=>{Logger.textUpdate&&console.debug("%c"+a.trim(),Logger.css.update(t.$depth),r.nodeValue);let e=c();r.nodeValue!=e&&(r.nodeValue=e),Logger.textUpdate&&console.debug("%c"+a.trim(),Logger.css.update(t.$depth),e)},c=()=>{try{return t.$dependencyChangeFunction=n,evaluateTemplateLiteral(t,o)}catch(e){return Logger.textBroken&&console.error("%c"+a.trim(),Logger.css.broken(t.$depth),"\n",e),r.nodeValue}finally{t.$dependencyChangeFunction=null}};Logger.textCreate&&console.debug("%c"+a.trim(),Logger.css.create(t.$depth)),r.nodeValue=c(),t.whenUnload.then(()=>{Logger.textRemove&&console.debug("%c"+a.trim(),Logger.css.remove(t.$depth));let e=t=>{t.$parent&&e(t.$parent),t.$callbackMap.changeOnceDOM.forEach(e=>e.delete(n))};e(t)})}for(let[l,g]of getNodeAttributesMap(e))g.forEach(e=>{let r=e.value,a=r.replace(/{{/g,"${").replace(/}}/g,"}"),o=()=>{Logger.textUpdate&&console.debug("%c"+r.trim(),Logger.css.update(t.$depth),e.value);let a=n();e.value!=a&&(e.value=a),Logger.textUpdate&&console.debug("%c"+r.trim(),Logger.css.update(t.$depth),a)},n=()=>{try{return t.$dependencyChangeFunction=o,evaluateTemplateLiteral.call(l,t,a)}catch(n){return console.warn("%c"+r,"color: darkorange;","\n",n),e.value}finally{t.$dependencyChangeFunction=null}};e.value=n(),t.whenUnload.then(()=>{let e=t=>{t.$parent&&e(t.$parent),t.$callbackMap.changeOnce.forEach(e=>e.delete(o))};e(t)})})}function*getTextNodes(e){let t=/{{.*}}/,r=document.createTreeWalker(e,NodeFilter.SHOW_ALL,e=>1===e.nodeType&&e.hasAttribute("mv-each")?NodeFilter.FILTER_REJECT:3===e.nodeType&&t.exec(e.nodeValue)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP);for(;r.nextNode();)yield r.currentNode}function*getNodeAttributesMap(e){let t=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,e=>e.hasAttribute("mv-each")?NodeFilter.FILTER_REJECT:e.attributes.length?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP);do{let r=Array.from(t.currentNode.attributes).filter(e=>/{{.*}}/.exec(e.value));r.length&&(yield[t.currentNode,r])}while(t.nextNode())}export function mvAttr(e,t){for(let r of getAttrNodes(e)){let a=r.getAttribute("mv-attr"),o=`mv-attr="${a}"`,n;Logger.attrCreate&&console.debug("%c"+o,Logger.css.create(t.$depth));let c=()=>{let e=l();JSON.stringify(n)!==JSON.stringify(e)&&(Object.entries(n=e).forEach(([e,t])=>{t?r.setAttribute(e,booleanAttributeList.includes(e)?"":t):r.removeAttribute(e)}),Logger.attrUpdate&&console.debug("%c"+o,Logger.css.update(t.$depth),n))},l=()=>{try{return t.$dependencyChangeFunction=c,evaluateAsObject(t,a)}catch(e){Logger.attrBroken&&console.error("%c"+o,Logger.css.broken(t.$depth),"\n",e)}finally{t.$dependencyChangeFunction=null}};c(),t.whenUnload.then(()=>{Logger.attrRemove&&console.debug("%c"+o,Logger.css.remove(t.$depth));let e=t=>{t.$parent&&e(t.$parent),t.$callbackMap.changeOnceDOM.forEach(e=>e.delete(c))};e(t)})}}let booleanAttributeList=["allowfullscreen","async","autofocus","autoplay","checked","controls","default","defer","disabled","formnovalidate","inert","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","selected","shadowrootclonable","shadowrootdelegatesfocus","shadowrootserializable"];function*getAttrNodes(e){let t=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,e=>e.hasAttribute("mv-each")?NodeFilter.FILTER_REJECT:e.hasAttribute("mv-attr")?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP);for(;t.nextNode();)yield t.currentNode}